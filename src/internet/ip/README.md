# [Internet Protocol](https://tools.ietf.org/html/rfc791)

詳細は [rfc791](https://tools.ietf.org/html/rfc791)を．  

## 概要

IPは **データグラム** と呼ばれるデータのブロックをsrcからdstに送信する機能を提供する．  
ここで，srcとdstは固定長アドレスで識別されるホストである．  

また，**スモールパケット** がネットワークを流れるように，  
必要に応じて大きなデータグラムの断片化( **フラグメンテーション** )と再構築( **リアセンブル** )を行う．  

｢相互接続されたシステム間でデータグラムを送受信する為に必要な機能｣に制限しているため，  
データの信頼性を担保するような仕組み等は定義されていない．  

### アドレッシング

データグラムはアドレスの解釈に基づいて，  
srcのインターネットモジュールからdstのインターネットモジュールに送信される．  
これは，IPが提供する機能の一つに **アドレッシング** がある，という意味である．  

アドレスは4オクテット(32bit)からなり，固定長である．  
前半をネットワーク部( rfcでは *network number* と呼称 )，  
後半をホスト部( rfcでは *local address* と呼称)と呼ぶ．  

### フラグメンテーション

データグラムのフラグメンテーションは，  
大きなパケットサイズを許容するローカルネットと，  
小さなパケットサイズのみ許容するように制限されたローカルネット間でパッシングが行われる際に必要である．  

データグラムは *don't fragment.* としてマークすることが可能．  
マークされたデータグラムに対するフラグメンテーションはいかなる場合でも起こらない．  
このようなデータグラムが宛先に送信できない場合，  
代わりにデータグラムを破棄する．  

データグラムのフラグメンテーションでは，  
フラグメント(データグラムの断片)をほぼ任意の数に分割できるが，  
後にリアセンブル可能になっていなければならない．  

フラグメントの受信側は，  
パケットヘッダの *identification* フィールドを利用して，  
異なるデータグラムのフラグメントを一緒くたにしないような仕組みが必要である．  
パケットヘッダの *fragment offset* フィールドは，  
元のデータグラムのうち，フラグメントがどの位置に属するかを受信側に伝える．  

フラグメントオフセットと(フラグメントの)長さによって，  
元のデータグラムのうち，このフラグメントがカバーする部分を計算できる．  

## 実際の動作

### ルーター

サーバからクライアントに対して通信が行われたとき,  
介在するルーターはL2ヘッダの宛先物理アドレスを読んで,  
自身のものと比較する.  

その後, 次ホップの物理アドレスを格納したパケットを構築して転送する.  

IPアドレスから物理アドレスを得るために用いられるのがARPである.  
詳細は[こちら](../arp/README.md).  

### クライアント

クライアントは自身の物理アドレスとIPアドレスを持っているので,  
各ヘッダの宛先アドレスを自身のものと比較しながら取り外していけば良い.  

この処理もプロトコルスタックによって隠蔽されている部分である.  
